# Coend calculus

_Coend calculus_ rules the behaviour of certain universal objects associated to functors of two variables $T : C^{op}\times C \to D$; intuitively, $end(T)$ stands to $T$ as the limit $\lim F$ of $F : A \to B$ stands to $F$; the major difference is that $end(T)$ takes into account the fact that $T$ eats two objects of $C$, once covariantly and once contravariantly: indeed, on arrows $f : c\to c'$ the functor $T$ acts as follows:

$$
\begin{array}{ccccc}
&& T(c',c) && \\
&\overset{T(f,c)}\swarrow && \overset{T(c',f)}\searrow &\\
T(c,c) &&&& T(c',c')
\end{array}
$$

A distinguising feature of objects that depend on the same variable once covariantly, and once contravariantly is that they can be _integrated_: given a sufficiently regular function $f(x)$, its dependence from $x$ can be thought as "covariant", whereas the "$dx$" in

$$
\int f(x)d x
$$

can be thought of as exhibiting a contravariant dependence of $\int f$ from $x$.

Ends and coends are associated to functors $T : C^{op}\times C \to D$ in a way that resembles integrals: they are certain objects $\int_c T(c,c)$ (the end) and $\int^c T(c,c)$ (the coend), associated to $T$ in a certain canonical fashion, treating $c$ as a mute variable (meaning that $\int_c T(c,c)$ and $\int_{c'} T(c',c')$ are the same object), and satisfying a "commutative rule of integrals" analogous to

$$
\int f(x,y) d x d y = \int \Big(\int f(x,y)d x\Big) d y = \int \Big(\int f(x,y)d y\Big) d x
$$

This intuition can of course be made more precise: every universal object built in category theory can be thought either as a subobject of a product (a limit), or as a quotient of a coproduct (a colimit), and co/ends make no exception:

-   An end arises as an "object of invariants" $\int_c T$ for the action of $T$ given by the arrow functions $T_{x y} : \hom_{C^{op}\times C}(x,y) \to D(T x, T y)$, and it is defined as the subobject of $\prod_{c\in C} T(c,c)$ of those elements invariant under this action.
-   Dually, a _coend_ arises quotienting $\coprod_{c\in C}T(c,c)$ by a suitable equivalence relation generated by same functions $T_{x y} : \hom_{C^{op}\times C}(x,y) \to D(T x, T y)$, i.e. as a _space of orbits_ for the action.

Quite astoundingly, starting from this simple intuition it is possible to find such covariant-contravariant actions at every corner of category theory, to re-state the Yoneda lemma and the theory of Kan extensions in terms of co/ends, and to find plenty of applications to algebra, topology, geometry... and functional programming. :-)

## Dinaturality

As already said, any functor $T : C^{op}\times C \to D$ acts on morphisms as

$$
\begin{array}{ccccc}
&& T(c',c) && \\
&\overset{T(f,c)}\swarrow && \overset{T(c',f)}\searrow &\\
T(c,c) &&&& T(c',c')
\end{array}
$$

given _two_ such functors, say $P,Q : C^{op}\times C \to D$, we can consider the two diagrams

$$
\begin{array}{ccccc}
&& P(c',c) && \\
&\overset{P(f,c)}\swarrow && \overset{P(c',f)}\searrow &\\
P(c,c) &&&& P(c',c')
\end{array}
$$

and

$$
\begin{array}{ccccc}
Q(c,c)&&&& Q(c',c')\\
&\underset{Q(c,f)}\nwarrow&& \underset{Q(f,c')}\nearrow& \\
&&Q(c,c')&&
\end{array}
$$

Given two functors $F,G : A \to B$ a natural transformation can be seen as a family of maps that "fill the gap" between $F(f)$ and $G(f)$ in a commutative square; in a similar fashion, a _dinatural_ transformation between the above $P,q$ can be seen as a way to close a certain diagram that testifies a transformation from the arrow action of $P$ to the arrow action of $Q$:

$$
\begin{array}{ccccc}
&& P(c',c) && \\
&\overset{P(f,c)}\swarrow && \overset{P(c',f)}\searrow &\\
P(c,c) &&&& P(c',c')\\
\!\!\!\!{\color{red} \alpha_c\downarrow} &&&&\,\,\,\,\,\,\,{\color{red}\downarrow\alpha_{c'}} \\
Q(c,c)&&&& Q(c',c')\\
&\underset{Q(c,f)}\nwarrow&& \underset{Q(f,c')}\nearrow& \\
&&Q(c,c')&&
\end{array}
$$

Just as co/limits are defined via suitable transformation to/from a constant, so are co/ends:

-   If $ Q : C^{op}\times C \to D$, a _wedge for $Q$ with base $x$_ consists of a dinatural transformation from the constant functor on $x\in D$, i.e. of a family of morphisms $\alpha_c : x\to Q(c,c)$ such that for each $f :c\to c'$ the above hexagon reduces to a commutative square:

$$
\begin{array}{ccc}
x &\to& Q(c,c)\\
\downarrow && \downarrow\\
Q(c',c') &\to & Q(c,c')
\end{array}
$$

-   If $P : C^{op}\times C \to D$, a _cowedge for $P$ with tip $y$_ consists of a dinatural transformation to the constant functor on $y\in D$, i.e. of a family of morphisms $\alpha_c : P(c,c) \to y$ such that for each $f :c\to c'$ the above hexagon reduces to a commutative square:

$$
\begin{array}{ccc}
P(c',c) &\to& P(c,c)\\
\downarrow && \downarrow\\
P(c',c') &\to & y
\end{array}
$$

There exists a category $Wd(Q)$ of wedges, defined with an obvious choice of morphisms between bases; similarly, there is a category of cowedges $Cwd(P)$.

The _end_ $\int_c Q(c,c)$ of $Q$ is now defined as a terminal object in the category of its wedges; dually, the _coend_ $\int^c P(c,c)$ of $P$ is the initial object of the category of its cowedges. Of course, we say "the" end because such an initial object is unique up to unique isomorphism when it exists.

So far, so good. In fact, we didn't stray much far from plain old category theory, as it is possible to show the following:

*Lemma (co/ends are colimits)*: Given $Q : C^{op}\times C \to D$ there exist a category $\widetilde{C}$ and a functor $\widetilde Q : \widetilde C \to D$ such that

$$
\int_c Q(c,c) \cong \lim \,\widetilde Q
$$

For those who know: the end of $Q$ is the [weighted colimit]() of $Q : C^{op}\times C \to D$ with the $\hom_C$ functor $C^{op}\times C \to Set$, and thus the category $\widetilde{C}$ is nothing more, nothing less than the [category of elements]() of $\hom_C$; this allows for a very explicit presentation of $\widetilde{C}$:

-   objects: the arrows of $C$, $f : c \to c'$;
-   morphisms: the commutative squares

$$
\begin{array}{ccc}
c &\leftarrow& d \\
{}^f\downarrow && \downarrow^g\\
c' &\to& d'
\end{array}
$$

*Corollary (hom commutes with all ends):* As a consequence of the fact that $\int_c Q$ is a limit, there is an isomorphism
$$
\hom_C\Big(y, \int_c P(c,c)\Big) \cong \int_c \hom_C(y, P(c,c))
$$
Dually,
$$
\hom_C\Big( \int^c P(c,c), y \Big )\cong \int_c \hom_C(P(c,c), y).
$$

There's only a mystery to uncover, before we start doing some explicit computations: why are co/ends denoted as integrals? The notation dates back to Yoneda, and it is essentially motivated by the fact that an end behaves like an integral:

*Theorem (Fubini rule):* Let $P : C^{op}\times C \times D^{op}\times D \to E$ be a functor; then

$$
\int^c\left(\int^d P(c,c,d,d)\right) \cong
\int^{(c,d)}P(c,d,c,d)
\cong \int^d\left(\int^c P(c,c,d,d)\right)
$$

in the sense that if one of the three objects exists, so do the other two, and they are all canonically isomorphic (the category $C^{op}\times C \times D^\text{op}\times D$ is of course equal to $(C\times D)^\text{op}\times( C \times D)$). Similarly, there is such a rule for ends.

Thus, in category theory integration with respect to a variable is a process that can happen in whatever order we desire: given a permutation $\sigma$ of the set $\{1,\dots,n\}$, whenever the integral

$$
\int^{C_{\sigma 1}}\int^{C_{\sigma 2}}\cdots \int^{C_{\sigma n}} P(c_{\sigma 1},  c_{\sigma 1}, c_{\sigma 2}, c_{\sigma 2}, \dots, c_{\sigma n}, c_{\sigma n})
$$

exists, then so does

$$
\int^{(c_1,\dots, c_n)} P(c_1, c_1, c_2, c_2, \dots, c_n, c_n)
$$

## The building blocks of co/end calculus

Nat - Yoneda - Kan

# Profunctors

Pastro and Street paper makes heavy use of the theory of _profunctors_.

# Doubles for monoidal categories
